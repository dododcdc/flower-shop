# ProductServiceImpl 剩余代码评审问题

## 🟡 中等紧急程度 - 建议尽快修复

### 1. 返回值处理不一致 (第67-69行)
```java
public IPage<Product> getOnlineProductsPage(int current, int size) {
    Page<Product> page = new Page<>(current, size);
    return productMapper.selectOnlineProductsPage(page); // 没有设置主图信息
}
```
**问题**：与其他方法不一致，没有设置主图信息
**建议**：调用 `setMainImagesForProducts(products)` 方法

### 2. 事务边界问题 (第249行)
```java
String imagePath = FileUploadUtil.uploadFile(newImg.getImageFile(), fileUploadConfig.getUploadPath());
```
**问题**：文件上传在事务外，但数据库记录在事务内，可能导致不一致
**建议**：考虑在事务提交后再执行文件上传，或者确保文件操作失败时能回滚

### 3. 内存泄漏风险 (第240行)
```java
productImageMapper.updateById(updateImg);
```
**问题**：在`updateProductWithImages`方法中，文件上传失败后可能导致临时文件未清理
**建议**：添加文件清理机制

## 🟢 低紧急程度 - 代码质量优化

### 4. 长方法需要拆分
**方法**：`createSampleProducts` (第485-520行)
**问题**：方法过长，职责不单一
**建议**：拆分为多个小方法：
- `deleteAllSampleProducts()`
- `createSampleProductsForCategory()`
- `generateProductVariants()`

### 5. 硬编码数据应该配置化
**位置**：第496-497行
```java
String[] namePrefixes = {"精品", "豪华", "浪漫", "经典", "雅致", "清新", "温馨", "时尚"};
String[] occasions = {"生日", "纪念日", "求婚", "道歉", "感谢", "祝福", "商务", "节日"};
```
**建议**：移到配置文件或常量类

### 6. 注释不完整 (第384-386行)
```java
// 这里应该从categoryService获取分类信息
// 简化处理
```
**问题**：TODO注释未实现
**建议**：完善注释或实现完整逻辑

### 7. 可以优化的逻辑
**位置**：第298-301行
```java
// 删除物理文件
if (!imagePaths.isEmpty()) {
    FileUploadUtil.deleteFiles(imagePaths, fileUploadConfig.getUploadPath());
}
```
**建议**：可以考虑异步删除文件，提高性能

## 📋 修复建议优先级

### 高优先级（本周内）
1. 修复返回值处理不一致问题
2. 处理事务边界问题
3. 添加文件清理机制

### 中优先级（下次迭代）
1. 拆分长方法
2. 配置化硬编码数据
3. 完善注释和TODO项

### 低优先级（有时间时）
1. 异步文件删除优化
2. 其他代码质量改进

## 🎯 额外建议

1. **添加单元测试**：特别是 `setMainImagesForProducts` 方法
2. **性能监控**：添加方法执行时间监控
3. **错误处理**：考虑添加更详细的错误分类
4. **文档完善**：为复杂方法添加详细的JavaDoc

---

**记录时间**：2025-11-24
**记录人**：Claude Code Assistant
**下次检查**：建议一周后检查修复进度