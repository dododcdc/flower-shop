<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.flower.shop.mapper.OrderMapper">

    <!-- 根据客户手机号分页查询订单 -->
    <select id="selectOrdersByCustomerPhone" resultType="com.flower.shop.entity.Order">
        SELECT
            o.id,
            o.order_no,
            o.customer_name,
            o.customer_phone,
            o.total_amount,
            o.delivery_fee,
            o.final_amount,
            o.status,
            o.payment_method,
            o.payment_status,
            o.delivery_time,
            o.notes,
            o.card_content,
            o.card_sender,
            o.created_at,
            o.updated_at
        FROM orders o
        WHERE o.customer_phone = #{phone}
        <if test="status != null and status != '' and status != 'ALL'">
            AND o.status = #{status}
        </if>
        ORDER BY o.created_at DESC
    </select>

    <!-- 根据用户ID分页查询订单 -->
    <select id="selectOrdersByUserIdPage" resultType="com.flower.shop.entity.Order">
        SELECT
            o.id,
            o.user_id,
            o.order_no,
            o.customer_name,
            o.customer_phone,
            o.total_amount,
            o.delivery_fee,
            o.final_amount,
            o.status,
            o.payment_method,
            o.payment_status,
            o.delivery_time,
            o.notes,
            o.card_content,
            o.card_sender,
            o.created_at,
            o.updated_at
        FROM orders o
        WHERE o.user_id = #{userId}
        <if test="status != null and status != '' and status != 'ALL'">
            AND o.status = #{status}
        </if>
        ORDER BY o.created_at DESC
    </select>

    <!-- 管理端：搜索订单（支持分页、筛选、排序） -->
    <select id="searchOrders" resultType="com.flower.shop.entity.Order">
        SELECT
            o.id,
            o.user_id,
            o.order_no,
            o.customer_name,
            o.customer_phone,
            o.total_amount,
            o.delivery_fee,
            o.final_amount,
            o.status,
            o.payment_method,
            o.payment_status,
            o.delivery_time,
            o.notes,
            o.card_content,
            o.card_sender,
            o.created_at,
            o.updated_at,
            COALESCE(da.address_text, o.notes) as address_text,
            COALESCE(item_counts.item_count, 0) as item_count
        FROM orders o
        LEFT JOIN delivery_addresses da ON da.order_id = o.id
        LEFT JOIN (
            SELECT order_id, COUNT(id) as item_count
            FROM order_items
            GROUP BY order_id
        ) item_counts ON item_counts.order_id = o.id
        WHERE 1=1
        <if test="keyword != null and keyword != ''">
            AND (o.order_no LIKE CONCAT('%', #{keyword}, '%')
                OR o.customer_name LIKE CONCAT('%', #{keyword}, '%')
                OR o.customer_phone LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        <if test="status != null and status != ''">
            AND o.status = #{status}
        </if>
        <if test="startDate != null and startDate != ''">
            AND DATE(o.created_at) &gt;= #{startDate}
        </if>
        <if test="endDate != null and endDate != ''">
            AND DATE(o.created_at) &lt;= #{endDate}
        </if>
        <choose>
            <when test="sortBy == 'final_amount' and sortOrder == 'asc'">
                ORDER BY o.final_amount ASC
            </when>
            <when test="sortBy == 'final_amount' and sortOrder == 'desc'">
                ORDER BY o.final_amount DESC
            </when>
            <when test="sortBy == 'created_at' and sortOrder == 'asc'">
                ORDER BY o.created_at ASC
            </when>
            <otherwise>
                ORDER BY o.created_at DESC
            </otherwise>
        </choose>
    </select>

    <!-- 查询订单详情（包含配送地址和订单项） -->
    <select id="selectOrderDetail" resultMap="orderDetailResultMap">
        SELECT
            o.id,
            o.user_id,
            o.order_no,
            o.customer_name,
            o.customer_phone,
            o.total_amount,
            o.delivery_fee,
            o.final_amount,
            o.status,
            o.payment_method,
            o.payment_status,
            o.delivery_time,
            o.notes,
            o.card_content,
            o.card_sender,
            o.created_at,
            o.updated_at,
            da.address_text as address_text,
            oi.id as item_id,
            oi.product_id,
            oi.product_name as product_snapshot_name,
            oi.product_price as unit_price,
            oi.quantity,
            oi.total_price as subtotal
        FROM orders o
        LEFT JOIN delivery_addresses da ON da.order_id = o.id
        LEFT JOIN order_items oi ON oi.order_id = o.id
        WHERE o.id = #{orderId}
    </select>

    <!-- 订单详情ResultMap -->
    <resultMap id="orderDetailResultMap" type="com.flower.shop.entity.Order">
        <id property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="orderNo" column="order_no"/>
        <result property="customerName" column="customer_name"/>
        <result property="customerPhone" column="customer_phone"/>
        <result property="totalAmount" column="total_amount"/>
        <result property="deliveryFee" column="delivery_fee"/>
        <result property="finalAmount" column="final_amount"/>
        <result property="status" column="status"/>
        <result property="paymentMethod" column="payment_method"/>
        <result property="paymentStatus" column="payment_status"/>
        <result property="deliveryTime" column="delivery_time"/>
        <result property="notes" column="notes"/>
        <result property="cardContent" column="card_content"/>
        <result property="cardSender" column="card_sender"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="addressText" column="address_text"/>
        <collection property="items" javaType="java.util.List" ofType="com.flower.shop.entity.OrderItem">
            <id property="id" column="item_id"/>
            <result property="orderId" column="id"/>
            <result property="productId" column="product_id"/>
            <result property="productName" column="product_snapshot_name"/>
            <result property="unitPrice" column="unit_price"/>
            <result property="quantity" column="quantity"/>
            <result property="subtotal" column="subtotal"/>
        </collection>
    </resultMap>

</mapper>