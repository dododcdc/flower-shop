# 订单管理功能 - 实现方案（最终版）

## 一、确认的设计决策

### 1. 功能范围
- ✅ 可以查询所有订单
- ✅ 取消订单时自动恢复库存
- ✅ 按订单金额确认收款（不需要输入实收金额）
- ❌ 暂时不实现实时提醒（后续评估）
- ✅ 需要显示完整配送地址（从delivery_addresses表查询）
- ❌ 打印和导出功能暂不实现
- ✅ 分两期实现

### 2. 分期方案
- **Phase 1**：基础列表展示（只查看）
- **Phase 2**：订单操作功能（管理订单）

---

## 二、Phase 1: 基础列表展示

### 2.1 页面布局
```
┌─────────────────────────────────────────────────────┐
│ 🔍 搜索订单号/客户姓名/手机号                         │
├─────────────────────────────────────────────────────┤
│ 状态: [全部][待确认][准备中][配送中][已完成][已取消]│
│ 日期: [今天][本周][本月]                             │
│ 排序: [最新][金额↓][金额↑]               [重置筛选] │
├─────────────────────────────────────────────────────┤
│ ┌───────────────────────────────────────────────┐   │
│ │ 🛒 FH20250102001         [待确认]            │   │
│ │ 👤 张三 138****1234       💰 ¥328.00         │   │
│ │ 📍 上海市浦东新区...                         │   │
│ │ 📦 3件商品    ⏰ 今天 16:00-18:00             │   │
│ │ 📝 备注：请在贺卡上写"生日快乐"               │   │
│ │                                          │   │
│ │             [查看详情]                      │   │
│ └───────────────────────────────────────────────┘   │
│ ...                                                  │
├─────────────────────────────────────────────────────┤
│                   < 1 2 3 ... 10 >                   │
└─────────────────────────────────────────────────────┘
```

### 2.2 功能清单
- ✅ 订单列表页面布局（3行筛选区域）
- ✅ 搜索框（订单号/客户姓名/手机号，防抖500ms）
- ✅ 状态筛选chips（全部/待确认/准备中/配送中/已完成/已取消）
- ✅ 时间范围筛选chips（全部/今天/本周/本月）
- ✅ 排序chips（最新/金额高→低/金额低→高）
- ✅ 重置筛选按钮
- ✅ 订单卡片展示（基本信息）
- ✅ 分页组件
- ✅ 空状态提示

### 2.3 订单卡片字段
| 字段 | 说明 | 来源 |
|------|------|------|
| 订单号 | FH20250102001 | orders.order_no |
| 状态标签 | 待确认/准备中/配送中/已完成/已取消 | orders.status |
| 客户信息 | 张三 138****1234 | orders.customer_name/customer_phone（脱敏） |
| 配送地址 | 前20个字符+... | delivery_addresses.address_text |
| 商品数量 | 3件商品 | 计算order_items记录数 |
| 期望配送时间 | 今天 16:00-18:00 | orders.delivery_time |
| 备注 | 用户备注 | orders.notes |

### 2.4 后端API
```java
// 查询订单列表
GET /api/orders/search?page=1&size=10&status=PENDING&startDate=&endDate=&keyword=

// 查询订单详情
GET /api/orders/{id}
```

### 2.5 数据库查询要点
- 关联查询 `delivery_addresses` 表获取地址
- 联合查询 `order_items` 表计算商品数量
- 支持分页（MyBatis-Plus Page）
- 支持动态条件（@TableField注解）

---

## 三、Phase 2: 订单操作功能

### 3.1 订单详情弹窗
```
┌────────────────────────────────────┐
│ 订单详情              [✕ 关闭]   │
├────────────────────────────────────┤
│ 基本信息                             │
│ ├─ 订单号: FH20250102001           │
│ ├─ 订单状态: 准备中                 │
│ ├─ 下单时间: 2025-01-02 14:30      │
│ ├─ 支付方式: 到付                  │
│ └─ 支付状态: 待支付                 │
│                                      │
│ 客户信息                             │
│ ├─ 姓名: 张三                       │
│ ├─ 手机: 13812341234                │
│ └─ 地址: 上海市浦东新区...          │
│                                      │
│ 商品信息                             │
│ ├─ 玫瑰花束 ×1    ¥199.00          │
│ ├─ 百合花束 ×2    ¥258.00          │
│ └─ 商品总价:      ¥457.00          │
│                                      │
│ 费用明细                             │
│ ├─ 商品总价: ¥457.00                │
│ ├─ 配送费:   ¥10.00                 │
│ └─ 最终金额: ¥467.00                │
│                                      │
│ 配送信息                             │
│ ├─ 期望配送: 今天 16:00-18:00        │
│ ├─ 贺卡内容: 生日快乐               │
│ ├─ 贺卡署名: 小明                   │
│ └─ 订单备注: 请准时配送             │
│                                      │
│ 操作按钮                             │
│     [确认订单]                       │
└────────────────────────────────────┘
```

### 3.2 订单状态流转

| 当前状态 | 可执行操作 | 操作后状态 | 按钮 |
|---------|-----------|-----------|------|
| 待确认 | 确认订单 | 准备中 | [确认订单] |
| 待确认 | 取消订单 | 已取消 | [取消订单] |
| 准备中 | 开始配送 | 配送中 | [开始配送] |
| 准备中 | 取消订单 | 已取消 | [取消订单] |
| 配送中 | 完成配送并收款 | 已完成+已支付 | [完成配送并收款] |
| 已完成 | - | - | [查看详情] |
| 已取消 | - | - | [查看详情] |

### 3.3 取消订单逻辑
```java
// 取消订单时需要：
1. 修改订单状态：CANCELLED
2. 恢复库存：遍历order_items，增加对应商品的stock_quantity
3. 记录取消原因（可选）
```

### 3.4 完成配送并收款逻辑
```java
// 完成配送时需要：
1. 修改订单状态：COMPLETED
2. 修改支付状态：PAID
3. 记录完成时间
```

### 3.5 后端API
```java
// 确认订单
PUT /api/orders/{id}/confirm
Body: { }

// 开始配送
PUT /api/orders/{id}/deliver
Body: { }

// 完成配送并收款
PUT /api/orders/{id}/complete
Body: { }

// 取消订单
PUT /api/orders/{id}/cancel
Body: { reason: "客户要求取消" }
```

### 3.6 库存恢复实现
```java
@Transactional
public void cancelOrder(Long orderId, String reason) {
    // 1. 修改订单状态
    Order order = orderMapper.selectById(orderId);
    order.setStatus("CANCELLED");
    orderMapper.updateById(order);

    // 2. 恢复库存
    List<OrderItem> items = orderItemMapper.selectList(
        new QueryWrapper<OrderItem>().eq("order_id", orderId)
    );

    for (OrderItem item : items) {
        Product product = productMapper.selectById(item.getProductId());
        product.setStockQuantity(
            product.getStockQuantity() + item.getQuantity()
        );
        productMapper.updateById(product);
    }
}
```

---

## 四、数据库表关系

```
orders (订单表)
├─ id (主键)
├─ order_no (订单号)
├─ customer_name (客户姓名)
├─ customer_phone (客户手机)
├─ status (订单状态)
├─ payment_status (支付状态)
├─ total_amount (商品总价)
├─ delivery_fee (配送费)
├─ final_amount (最终金额)
├─ delivery_time (期望配送时间)
├─ notes (备注)
├─ card_content (贺卡内容)
├─ card_sender (贺卡署名)
├─ created_at (创建时间)
└─ updated_at (更新时间)

delivery_addresses (配送地址表)
├─ id (主键)
├─ order_id (关联订单ID)
├─ customer_name (客户姓名)
├─ customer_phone (客户手机)
└─ address_text (地址文本)

order_items (订单项表)
├─ id (主键)
├─ order_id (关联订单ID)
├─ product_id (商品ID)
├─ product_name (商品名称)
├─ product_price (商品单价)
├─ quantity (数量)
└─ total_price (小计)
```

---

## 五、实现优先级

### Phase 1（当前）
- 优先级：P0（最高）
- 预计工作量：2-3天
- 价值：老板可以查看所有订单

### Phase 2（下一步）
- 优先级：P1（高）
- 预计工作量：3-4天
- 价值：老板可以管理订单流程

### Phase 3（未来）
- 实时订单提醒
- 打印订单
- 导出Excel
- 批量操作
- 数据统计

---

## 六、技术要点

### 6.1 前端
- 使用和商品管理一致的chips筛选风格
- 搜索框防抖500ms
- 中文输入法支持（composition事件）
- 订单卡片状态颜色区分

### 6.2 后端
- MyBatis-Plus关联查询
- 事务管理（取消订单恢复库存）
- 统一返回格式（Result/OrderVO）
- 参数校验（@Validated）

### 6.3 数据库
- 关联查询 delivery_addresses
- 聚合查询 order_items
- 事务回滚保证库存一致性

---

## 七、验收标准

### Phase 1
- [ ] 可以看到所有订单列表
- [ ] 支持按状态筛选
- [ ] 支持按时间筛选
- [ ] 支持搜索订单号/客户姓名/手机号
- [ ] 支持按金额排序
- [ ] 点击"查看详情"显示完整订单信息
- [ ] 分页正常工作
- [ ] 无订单时显示友好提示

### Phase 2
- [ ] 确认订单：待确认 → 准备中
- [ ] 开始配送：准备中 → 配送中
- [ ] 完成配送：配送中 → 已完成 + 支付状态→已支付
- [ ] 取消订单：准备中 → 已取消 + 库存恢复
- [ ] 所有操作有确认对话框
- [ ] 操作成功有提示消息
- [ ] 订单详情显示完整信息

---

## 八、风险和注意事项

### 8.1 技术风险
- **库存并发**：取消订单时库存可能被其他订单占用
  - 解决：使用乐观锁（version字段）或分布式锁
- **事务回滚**：库存恢复失败时订单状态不能改变
  - 解决：使用@Transactional保证原子性

### 8.2 业务风险
- **误取消**：老板可能误点取消
  - 解决：二次确认对话框
- **重复操作**：网络慢时可能重复点击
  - 解决：按钮loading状态，操作完成后才恢复

### 8.3 用户体验
- **空状态**：无订单时不要显示空白
  - 解决：显示友好提示和插画
- **加载状态**：操作时要有loading提示
  - 解决：按钮loading状态，骨架屏

---

## 九、下一步

开始实现 Phase 1：
1. 创建订单管理页面组件
2. 实现后端订单查询API
3. 实现前端筛选和搜索
4. 实现订单卡片展示
5. 实现分页功能
6. 实现订单详情弹窗

准备好开始了吗？
