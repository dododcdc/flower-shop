# 订单查询问题修复总结

## 问题描述
在 `http://localhost:5173/shop/orders` 页面输入手机号 `13265796277` 点击查询时，界面显示错误：
```
Cannot read properties of null (reading 'records')
```

虽然数据库中执行 `SELECT * FROM orders WHERE customer_phone = '13265796277'` 可以查到数据。

## 问题原因

### 根本原因
MyBatis XML 映射文件中的参数名与 Java 接口中的 `@Param` 注解不匹配：

**OrderMapper.java (第114行):**
```java
IPage<Order> selectOrdersByCustomerPhone(IPage<Order> page, @Param("phone") String phone);
```

**OrderMapper.xml (第25行):**
```xml
WHERE o.customer_phone = #{customerPhone}
```

参数名不匹配导致 SQL 查询失败，返回 null，进而导致前端访问 `response.records` 时报错。

### 相关问题
1. 后端 `Order` 实体的 `status` 字段在数据库中是字符串类型（如 "PREPARING", "PENDING"），但前端 API 接口定义为 `number` 类型
2. 前端 `OrderInfo` 接口与后端返回的数据结构不匹配
3. 前端缺少对 API 响应的空值检查

## 修复方案

### 1. 修复 MyBatis XML 参数名
**文件:** `/Users/wenbin/Projects/flower_shop/flower_server/src/main/resources/mapper/OrderMapper.xml`

**修改前:**
```xml
WHERE o.customer_phone = #{customerPhone}
```

**修改后:**
```xml
WHERE o.customer_phone = #{phone}
```

### 2. 更新前端 Order 接口定义
**文件:** `/Users/wenbin/Projects/flower_shop/flower_ui/src/api/orderAPI.ts`

**修改前:**
```typescript
export interface Order {
    id: number;
    orderNo: string;
    customerName: string;
    customerPhone: string;
    totalAmount: number;
    finalAmount: number;
    status: number;
    deliveryTime?: string;
    cardContent?: string;
    cardSender?: string;
    createdAt: string;
}
```

**修改后:**
```typescript
export interface Order {
    id: number;
    orderNo: string;
    customerName: string;
    customerPhone: string;
    totalAmount: number;
    finalAmount: number;
    deliveryFee: number;
    status: string; // "PENDING" | "PAID" | "PREPARING" | "DELIVERING" | "COMPLETED" | "CANCELLED"
    paymentMethod: string;
    paymentStatus: string;
    deliveryTime?: string;
    notes?: string;
    cardContent?: string;
    cardSender?: string;
    createdAt: string;
    updatedAt: string;
}
```

### 3. 统一前端类型定义
**文件:** `/Users/wenbin/Projects/flower_shop/flower_ui/src/pages/shop/OrderListPage.tsx`

- 移除本地的 `OrderInfo` 接口定义
- 直接使用 `orderAPI.ts` 中的 `Order` 类型
- 移除未使用的导入（`useNavigate`, `Divider`, `RefreshIcon` 等）
- 添加 `Pagination` 组件导入

### 4. 添加前端空值检查
**文件:** `/Users/wenbin/Projects/flower_shop/flower_ui/src/pages/shop/OrderListPage.tsx`

在 `handleSearch` 函数中添加响应数据的空值检查：

```typescript
const response = await orderAPI.getOrdersByPhone(searchPhone, page, 10);

// 添加空值检查
if (!response || !response.records) {
    setError('查询失败，服务器返回数据格式错误');
    setOrders([]);
    return;
}
```

### 5. 添加后端调试日志
**文件:** `/Users/wenbin/Projects/flower_shop/flower_server/src/main/java/com/flower/shop/controller/OrderController.java`

在 `getOrdersByPhone` 方法中添加日志输出，便于调试：

```java
System.out.println("查询订单 - 手机号: " + phone + ", 页码: " + page + ", 每页大小: " + size);
// ... 查询逻辑
System.out.println("查询结果 - 总数: " + orders.getTotal());
```

## 验证结果

### 后端 API 测试
```bash
curl -s "http://localhost:8080/api/orders/by-phone?phone=13265796277&page=1&size=10" | jq .
```

返回结果：
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "records": [...],  // 7条订单记录
    "total": 7,
    "size": 10,
    "current": 1,
    "pages": 1
  },
  "timestamp": 1764859450126
}
```

### 前端页面测试
访问 `http://localhost:5173/shop/orders`，输入手机号 `13265796277`，点击查询，成功显示订单列表。

## 经验总结

1. **参数名一致性**: MyBatis XML 映射文件中的参数占位符必须与 Java 接口中 `@Param` 注解的值完全一致
2. **类型匹配**: 前后端接口定义的数据类型必须与数据库实际存储的类型一致
3. **空值检查**: 前端应对所有 API 响应进行空值检查，避免运行时错误
4. **日志调试**: 在关键位置添加日志输出，便于快速定位问题
5. **类型复用**: 前端应尽量复用统一的类型定义，避免重复定义导致不一致

## 修改文件清单

1. `/Users/wenbin/Projects/flower_shop/flower_server/src/main/resources/mapper/OrderMapper.xml`
2. `/Users/wenbin/Projects/flower_shop/flower_server/src/main/java/com/flower/shop/controller/OrderController.java`
3. `/Users/wenbin/Projects/flower_shop/flower_ui/src/api/orderAPI.ts`
4. `/Users/wenbin/Projects/flower_shop/flower_ui/src/pages/shop/OrderListPage.tsx`
